global.currentUser = null;
global.currentSID = null;

//------------------------------------------------------------------------------

global.signIn = function(user, done) {
  var fakeAuth = stub(VoyagerPassport, "_authenticate");
      fakeAuth.yields(null, user);

  function callback(err, success) {
    fakeAuth.restore();
    done(err, success);
  }

  //-- request must be an instance of "supertest-session"
  request ? request.post("/login")
    .send({username: "test", password: "test"})
    .expect(200)
    .end(function(err, res) {
        if (err) {
          callback(err, false);
        } else {
          //-- set current user and sid
          currentUser = _.clone(user, true);
          currentSID = (((_.find(request.cookies || [],
                        sails.config.session.key) || {})[sails.config.session.key]
                        || "").match(/s:([^.]*)/) || [])[1] || null;
          callback(null, true);
        }
    }) : callback(true, false);
};

//------------------------------------------------------------------------------

global.signOut = function(done) {
  //-- request must be an instance of "supertest-session"
  request ? request.get("/logout")
    .expect(200)
    .end(function(err, res) {
        if (err) {
          done(err, false);
        } else {
          //-- clear cookies
          request.destroy();

          //-- unset current user and sid
          currentUser = null;
          currentSID = null;
          done(null, true);
        }
    }) : done(true, false);
};
